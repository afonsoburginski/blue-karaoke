# Publica release do Blue Karaoke Desktop (Tauri) no GitHub.
#
# Usa Bun para instalar dependências e build do frontend.
# A versão é lida de tauri.conf.json. Para lançar uma nova versão:
# 1. Atualize a versão em desktop/package.json, desktop/src-tauri/tauri.conf.json e desktop/src-tauri/Cargo.toml
# 2. Commit e push para main (a Action roda automaticamente)
# Ou: crie uma tag vX.Y.Z e dê push (ex.: git tag v1.1.2 && git push origin v1.1.2)
#
# Builds: Windows (NSIS installer) e Linux (.deb + .AppImage).
# Gera latest.json para auto-updater via tauri-plugin-updater.

name: Release Desktop (Tauri)

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs: {}

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ""
          - platform: ubuntu-22.04
            args: ""

    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        working-directory: desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libglib2.0-dev

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: desktop/src-tauri

      - name: Create .env for Supabase credentials
        shell: bash
        run: |
          cat > src-tauri/.env << 'ENVEOF'
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          R2_PUBLIC_URL=${{ secrets.R2_PUBLIC_URL }}
          ENVEOF

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      # Baixa o mpv portable para Windows e o coloca em src-tauri/resources/
      # O mpv é usado como player nativo para garantir compatibilidade com Windows 10
      # (bypassa o WebView2 que tem bugs de GPU compositing no Win10)
      - name: Download mpv for Windows
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          $MPV_VERSION = "0.40.0"
          $MPV_URL = "https://github.com/mpv-player/mpv/releases/download/v${MPV_VERSION}/mpv-x86_64-windows-msvc.zip"
          $ZIP_PATH = "$env:TEMP\mpv.zip"
          $RESOURCES_DIR = "desktop\src-tauri\resources"

          New-Item -ItemType Directory -Force -Path $RESOURCES_DIR | Out-Null

          Write-Host "Baixando mpv v${MPV_VERSION}..."
          try {
            Invoke-WebRequest -Uri $MPV_URL -OutFile $ZIP_PATH -UseBasicParsing
            Expand-Archive -Path $ZIP_PATH -DestinationPath "$env:TEMP\mpv-extract" -Force
            # Copiar mpv.exe e todas as DLLs necessárias para resources
            Get-ChildItem "$env:TEMP\mpv-extract" -Recurse -Include "*.exe","*.dll" | Copy-Item -Destination $RESOURCES_DIR
            Write-Host "mpv bundled com sucesso em $RESOURCES_DIR"
            Get-ChildItem $RESOURCES_DIR | Select-Object Name, Length
          } catch {
            Write-Host "AVISO: falha ao baixar mpv ($($_.Exception.Message)) - build continuará sem player nativo"
          }

      # Se aparecer "Detected unsettled top-level await" no log, é warning interno da action; pode ignorar.
      - name: Build Tauri app and create release
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: desktop
          tagName: v__VERSION__
          releaseName: Blue Karaoke __VERSION__
          releaseBody: "Instaladores para Windows e Linux do Blue Karaoke Desktop."
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
