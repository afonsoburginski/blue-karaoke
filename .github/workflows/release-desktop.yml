# Publica release do Blue Karaoke Desktop (Tauri) no GitHub.
#
# Disparos:
# 1) A cada push em main -> nova release com a versao definida nos arquivos fonte
# 2) workflow_dispatch -> build manual
#
# A versao eh lida de tauri.conf.json. Para lancar uma nova versao,
# basta atualizar a versao nos arquivos e fazer push.
#
# Builds: Windows (NSIS installer) e Linux (.deb + .AppImage).

name: Release Desktop (Tauri)

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs: {}

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: desktop

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from tauri.conf.json
        id: version
        shell: pwsh
        run: |
          $conf = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $version = $conf.version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Versao: $version"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: desktop/src-tauri

      - name: Create .env for Supabase credentials
        shell: pwsh
        run: |
          @"
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          R2_PUBLIC_URL=${{ secrets.R2_PUBLIC_URL }}
          "@ | Out-File -FilePath src-tauri/.env -Encoding utf8

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri (Windows NSIS)
        run: npx tauri build

      - name: Upload artefatos Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ steps.version.outputs.version }}
          path: |
            desktop/src-tauri/target/release/bundle/nsis/*.exe
            desktop/src-tauri/target/release/bundle/nsis/*.nsis.zip
            desktop/src-tauri/target/release/bundle/nsis/*.nsis.zip.sig

  build-linux:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from tauri.conf.json
        id: version
        run: |
          version=$(grep '"version"' src-tauri/tauri.conf.json | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Versao: $version"

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libglib2.0-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: desktop/src-tauri

      - name: Create .env for Supabase credentials
        run: |
          cat > src-tauri/.env << 'ENVEOF'
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          R2_PUBLIC_URL=${{ secrets.R2_PUBLIC_URL }}
          ENVEOF

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri (Linux deb + AppImage)
        run: npx tauri build

      - name: Upload artefatos Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ steps.version.outputs.version }}
          path: |
            desktop/src-tauri/target/release/bundle/deb/*.deb
            desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            desktop/src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz
            desktop/src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz.sig

  release:
    name: Criar Release no GitHub
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          version=$(grep '"version"' desktop/src-tauri/tauri.conf.json | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=v$version" >> $GITHUB_OUTPUT
          echo "Versao: $version"

      - name: Baixar artefatos Windows
        uses: actions/download-artifact@v4
        with:
          name: windows-${{ steps.version.outputs.version }}
          path: win

      - name: Baixar artefatos Linux
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ steps.version.outputs.version }}
          path: linux

      - name: Listar artefatos
        run: |
          echo "=== Windows ==="
          find win -type f 2>/dev/null || true
          echo "=== Linux ==="
          find linux -type f 2>/dev/null || true

      - name: Deletar release anterior com mesma versao (se existir)
        run: |
          gh release delete "v${{ steps.version.outputs.version }}" --yes --cleanup-tag 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Criar Release e enviar instaladores
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Blue Karaoke ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            win/**/*.exe
            linux/**/*.deb
            linux/**/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
