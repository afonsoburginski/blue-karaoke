# Publica release do Blue Karaoke Desktop (Tauri) no GitHub.
#
# Disparos:
# 1) A cada push em main → nova release com versão 1.0.<run_number>
# 2) Ao enviar uma tag v* → release com a versão da tag
# 3) workflow_dispatch → build manual
#
# Builds: Windows (NSIS installer) e Linux (.deb + .AppImage).

name: Release Desktop (Tauri)

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs: {}

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: desktop/src-tauri

      - name: Set version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.ref }}".StartsWith("refs/tags/v")) {
            $version = "${{ github.ref_name }}".TrimStart('v')
          } else {
            $version = "1.0.$env:GITHUB_RUN_NUMBER"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Versao: $version"

      - name: Update versions
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"

          # package.json
          (Get-Content package.json) -replace '"version":\s*"[^"]*"', "`"version`": `"$version`"" | Set-Content package.json

          # tauri.conf.json
          (Get-Content src-tauri/tauri.conf.json) -replace '"version":\s*"[^"]*"', "`"version`": `"$version`"" | Set-Content src-tauri/tauri.conf.json

          # Cargo.toml - somente a linha que comeca com version (package version)
          $cargo = Get-Content src-tauri/Cargo.toml
          $replaced = $false
          $cargo = $cargo | ForEach-Object {
            if (-not $replaced -and $_ -match '^version\s*=') {
              $replaced = $true
              "version = `"$version`""
            } else {
              $_
            }
          }
          Set-Content src-tauri/Cargo.toml $cargo

          echo "Versao atualizada para $version"

      - name: Create .env for Supabase credentials
        shell: pwsh
        run: |
          @"
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          R2_PUBLIC_URL=${{ secrets.R2_PUBLIC_URL }}
          "@ | Out-File -FilePath src-tauri/.env -Encoding utf8

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri (Windows NSIS)
        run: npx tauri build

      - name: Upload artefatos Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ steps.version.outputs.version }}
          path: |
            desktop/src-tauri/target/release/bundle/nsis/*.exe
            desktop/src-tauri/target/release/bundle/nsis/*.nsis.zip
            desktop/src-tauri/target/release/bundle/nsis/*.nsis.zip.sig

  build-linux:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libglib2.0-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: desktop/src-tauri

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="1.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Versao: $version"

      - name: Update versions
        run: |
          version="${{ steps.version.outputs.version }}"

          # package.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$version\"/" package.json

          # tauri.conf.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$version\"/" src-tauri/tauri.conf.json

          # Cargo.toml
          sed -i "s/^version = \"[^\"]*\"/version = \"$version\"/" src-tauri/Cargo.toml

          echo "Versao atualizada para $version"

      - name: Create .env for Supabase credentials
        run: |
          cat > src-tauri/.env << EOF
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          R2_PUBLIC_URL=${{ secrets.R2_PUBLIC_URL }}
          EOF

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri (Linux deb + AppImage)
        run: npx tauri build

      - name: Upload artefatos Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ steps.version.outputs.version }}
          path: |
            desktop/src-tauri/target/release/bundle/deb/*.deb
            desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            desktop/src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz
            desktop/src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz.sig

  release:
    name: Criar Release no GitHub
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version and tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="1.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=v$version" >> $GITHUB_OUTPUT
          echo "Versao: $version"

      - name: Baixar artefatos Windows
        uses: actions/download-artifact@v4
        with:
          name: windows-${{ steps.version.outputs.version }}
          path: win

      - name: Baixar artefatos Linux
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ steps.version.outputs.version }}
          path: linux

      - name: Listar artefatos
        run: |
          echo "=== Windows ==="
          find win -type f 2>/dev/null || true
          echo "=== Linux ==="
          find linux -type f 2>/dev/null || true

      - name: Criar Release e enviar instaladores
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Blue Karaoke ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            win/**/*.exe
            linux/**/*.deb
            linux/**/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
