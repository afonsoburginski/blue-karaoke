# Publica release do Blue Karaoke (desktop) no GitHub.
#
# Disparos:
# 1) A cada push em main → nova release com versão 1.0.<run_number>
# 2) Ao enviar uma tag v* → release com a versão da tag
#
# Builds: Windows (x64 + ia32) e Linux (Ubuntu: .deb + .tar.gz).

name: Release Desktop (Windows + Linux)

# Permissão para criar releases e fazer upload dos instaladores
permissions:
  contents: write

# Push em main = release 1.0.run_number. Tag v* = use outro workflow ou Run workflow manual.
on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set version
        id: version
        run: |
          if ("${{ github.ref }}".StartsWith("refs/tags/v")) {
            $version = "${{ github.ref_name }}".TrimStart('v')
          } else {
            $version = "1.0.$env:GITHUB_RUN_NUMBER"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Versão: $version"

      - name: Update package.json version
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $pkgPath = "package.json"
          (Get-Content $pkgPath) -replace '"version":\s*"[^"]*"', "`"version`": `"$version`"" | Set-Content $pkgPath
          Get-Content $pkgPath | Select-String "version"

      - name: Instalar dependências (Bun)
        run: bun install

      - name: Build Windows (x64 + ia32)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run electron:build:win:ci

      - name: Upload artefatos Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ steps.version.outputs.version }}
          path: |
            desktop/release/*.exe
            desktop/release/*.yml
            desktop/release/*.blockmap

  build-linux:
    runs-on: ubuntu-latest
    needs: build-windows
    defaults:
      run:
        working-directory: desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="1.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Versão: $version"

      - name: Update package.json version
        run: |
          version="${{ steps.version.outputs.version }}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$version\"/" package.json
          grep version package.json

      - name: Instalar dependências (Bun)
        run: bun install

      - name: Build Linux (deb + tar.gz)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run electron:build:linux:ci

      - name: Upload artefatos Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ steps.version.outputs.version }}
          path: |
            desktop/release/*.deb
            desktop/release/*.tar.gz

  release:
    name: Criar Release no GitHub
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version and tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="1.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=v$version" >> $GITHUB_OUTPUT
          echo "Versão: $version"

      - name: Baixar artefatos Windows
        uses: actions/download-artifact@v4
        with:
          name: windows-${{ steps.version.outputs.version }}
          path: win

      - name: Baixar artefatos Linux
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ steps.version.outputs.version }}
          path: linux

      - name: Criar Release e enviar instaladores
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            win/*.exe
            win/*.yml
            win/*.blockmap
            linux/*.deb
            linux/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
